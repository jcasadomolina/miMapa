<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa de {{ email_mapa }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { background-color: #f8f9fa; }
        #map { height: 500px; width: 100%; border-radius: 10px; }
        .thumbnail { max-width: 100px; max-height: 100px; object-fit: cover; }
        .form-card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .table-token { font-size: 0.75rem; color: #666; font-family: monospace; }
    </style>
</head>
<body class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3">Mapa de: <span class="text-primary">{{ email_mapa }}</span></h1>
            {% if not es_propietario %}
                <span class="badge bg-warning text-dark">Modo Visitante</span>
            {% else %}
                <span class="badge bg-success">Modo Propietario</span>
            {% endif %}
        </div>
        <a href="/" class="btn btn-outline-secondary">Volver al Inicio</a>
    </div>

    <div id="map" class="mb-5 shadow-sm border border-2 border-white"></div>

    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            
            {% if es_propietario %}
                <div class="card form-card">
                    <div class="card-header bg-primary text-white text-center py-3">
                        <h5 class="mb-0">üìç A√±adir Nuevo Destino</h5>
                    </div>
                    <div class="card-body p-4 bg-white">
                        <form action="/web/nuevo-marcador" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="email" value="{{ email_mapa }}">

                            <div class="mb-3">
                                <label class="form-label fw-bold">Ciudad</label>
                                <input type="text" name="ciudad" class="form-control" placeholder="Ej: Tokio, Jap√≥n" required>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Foto</label>
                                <input type="file" name="imagen" class="form-control" accept="image/*" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">Guardar Marcador</button>
                            </div>
                        </form>
                    </div>
                </div>

            {% else %}
                <div class="alert alert-info text-center p-4 shadow-sm" role="alert">
                    <h4 class="alert-heading">üó∫Ô∏è Est√°s explorando</h4>
                    <p>Est√°s viendo el mapa personal de <strong>{{ email_mapa }}</strong>.</p>
                    <hr>
                    <p class="mb-0">No puedes a√±adir marcadores aqu√≠, pero tu visita ha quedado registrada.</p>
                </div>
            {% endif %}

        </div>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">üëÄ Historial de Visitas Recibidas</h5>
        </div>
        <div class="card-body">
            {% if visitas %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Fecha</th>
                                <th scope="col">Visitante</th>
                                <th scope="col">Token (Fragmento)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in visitas %}
                            <tr>
                                <td style="width: 20%;">{{ v.fecha }}</td>
                                <td style="width: 30%;"><strong>{{ v.email_visitante }}</strong></td>
                                <td style="width: 50%;">
                                    <div class="text-break table-token">
                                        {{ v.token }}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center text-muted my-3">Este mapa a√∫n no ha recibido visitas de otros usuarios.</p>
            {% endif %}
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([20, 0], 2); // Vista global

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'OpenStreetMap'
        }).addTo(map);

        // Procesar marcadores desde Jinja a JS
        var marcadoresTexto = '{{ marcadores | tojson | safe }}';
        var marcadores = [];
        try {
            marcadores = JSON.parse(marcadoresTexto);
        } catch (e) { console.error(e); }

        if (marcadores && marcadores.length > 0) {
            marcadores.forEach(function(m) {
                var contenido = "<b>" + (m.ciudad || "?") + "</b><br>";
                if(m.img) {
                    contenido += "<img src='" + m.img + "' class='thumbnail mt-2'>";
                }
                
                var lat = parseFloat(m.lat);
                var lon = parseFloat(m.lon);
                
                if (!isNaN(lat) && !isNaN(lon)) {
                    L.marker([lat, lon]).addTo(map).bindPopup(contenido);
                }
            });
            // Centrar mapa si hay puntos
            if(marcadores.length > 0) {
                var group = new L.featureGroup(marcadores.map(m => L.marker([m.lat, m.lon])));
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }
    </script>
</body>
</html>